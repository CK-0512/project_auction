<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.auction.dao.AuctionDao">

	<select id="getAuctionCnt" resultType="int">
		SELECT COUNT(*)
			FROM auction
			WHERE endStatus = #{endStatus}
			<if test="categoryId != 0">
				AND categoryId = #{categoryId}
			</if>
			<if test="searchKeyword != ''">
				AND (
						`name` LIKE CONCAT('%', #{searchKeyword}, '%')
						OR `description` LIKE CONCAT('%', #{searchKeyword}, '%')
					)
			</if>
	</select>

	<select id="getAuctionContents" resultType="Auction">
		SELECT P.*
		        , A.regDate AS startDate
		        , A.endDate
		        , A.startBid
		        , A.endBid
		        , A.bidCount
		        , A.buyNow
			FROM product AS P
			INNER JOIN auction AS A
		    ON P.id = A.productId
		    WHERE A.endStatus = #{endStauts}
		    	<if test="searchKeyword != ''">
					AND (
						P.`name` LIKE CONCAT('%', #{searchKeyword}, '%')
						OR P.`description` LIKE CONCAT('%', #{searchKeyword}, '%')
						)
				</if>
				<if test="categoryId != 0">
					AND P.categoryId = #{categoryId}
				</if>
			LIMIT #{limitStart}, #{itemsInAPage}
	</select>
	
	<insert id="registAuction">
		INSERT INTO auction
			SET regDate = NOW()
				, updateDate = NOW()
				, memberId = #{memberId}
				, categoryId = #{categoryId}
				, startBid = #{startBid}
				, buyNow = #{buyNow}
				, bidDate = #{bidDate}
				, endDate = DATE_ADD(NOW(), INTERVAL #{bidDate} DAY)
				, charge = #{charge}
				, `name` = #{name}
				, `description` = #{description}
	</insert>
	
	<select id="getLastInsertId" resultType="int">
		SELECT LAST_INSERT_ID()
	</select>
	
	<select id="getAuctionById" resultType="auction">
		SELECT * 
			FROM auction
			WHERE id = #{id}
	</select>
	
	<update id="modifyAuction">
		UPDATE auction
			SET description = #{description}
			WHERE id = #{id}
	</update>
	
</mapper>